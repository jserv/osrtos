---
title: STM32 FatFS SD Card Remount Fix
summary: A specialized fix for the FatFS middleware on STM32 microcontrollers to resolve
  issues when re-mounting SD cards. It addresses the FR_DISK_ERR bug encountered during
  card reinsertion by properly resetting the disk initialization state in the diskio
  layer.
slug: stm32-fatfs-sd-card-remount-fix
codeUrl: https://github.com/artlukm/STM32_FATFS_SDcard_remount
star: 1
lastUpdated: '2022-12-23'
rtos: ''
topics:
- fatfs
- frdiskerr
- sdcard
- stm32
isShow: false
createdAt: '2026-01-04'
updatedAt: '2026-01-04'
---

## Resolving the FatFS SD Card Remount Bug

When working with SD cards and the FatFS middleware on STM32 microcontrollers, developers often encounter a frustrating issue: the system works perfectly upon the first boot, but fails to recognize the SD card if it is removed and reinserted. In these cases, the standard `f_mount()` function begins returning a `FR_DISK_ERR` error, effectively locking the application out of the file system until a hard reset occurs.

This project provides a targeted solution for this specific behavior, ensuring that SD cards can be hot-swapped or reinserted reliably without requiring a system reboot.

## The Root Cause

The problem typically stems from the internal state management within the `diskio.c` driver layer. When an SD card is first initialized, the driver sets an internal flag (often `is_initialized`) to indicate the hardware is ready. However, when the card is physically removed, FatFS does not always automatically clear this status. Upon reinsertion, the driver assumes the disk is still in its previous state, leading to communication failures and the dreaded `FR_DISK_ERR`.

## The Solution: disk_DeInitialize

To solve this, the project introduces a manual de-initialization step. By adding a function to zero out the initialization structure field, the driver is forced to perform a fresh hardware handshake when the card is re-mounted.

```c
void disk_DeInitialize (
	BYTE pdrv /* Physical drive number to identify the drive */
)
{
  disk.is_initialized[pdrv] = 0;
}
```

By calling this function during the unmounting process or immediately before a new `f_mount` attempt, the software state is synchronized with the physical state of the SD card slot.

## Implementation and Integration

This fix is particularly relevant for developers using STM32CubeIDE and the STM32 HAL libraries. The repository demonstrates how to modify the standard `diskio.c` file generated by CubeMX to include the de-initialization logic. 

Key integration steps include:
- Modifying `diskio.c` to include the `disk_DeInitialize` function.
- Updating the application logic to trigger this de-initialization when a card removal is detected.
- Ensuring the SPI or SDIO peripheral is ready for a clean re-initialization sequence.

This approach is compatible with various STM32 families, including the STM32F4 Discovery series, and is a vital patch for any embedded system requiring robust user-facing SD card slots.
